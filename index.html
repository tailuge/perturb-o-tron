<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="assets/chessground.css" async>
  <link rel="stylesheet" href="assets/theme.css" async>
  <link rel="stylesheet" href="assets/examples.css">
  <meta charset="utf-8">
  <title>Perturb-o-tron</title>
  <meta name="description" content="analysis stockfish">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <script src="dist/main.js"></script>
</head>

<body>
  perturb-o-tron
  <section class="blue merida">
    <div id="chessground-examples"></div>
  </section>
  <button onclick="fromBoard()">go</button>
</body>

<script defer>
  /* global bundle, WebAssembly */

  var wasmSupported = typeof WebAssembly === 'object' && WebAssembly.validate(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
  console.log("wasmSupported:" + wasmSupported);
  var stockfish = new Worker(wasmSupported ? 'vendor/stockfish.wasm.js' : 'vendor/stockfish.js');
  var stockfishQueue = new bundle.StockfishQueue(stockfish, console.log);

  var shapes = [];


  var fen = '3k4/8/1p6/8/8/4P3/8/3K4 w - - 0 1';
  var chessground = bundle.Chessground(document.getElementById('chessground-examples'), { fen: fen });
  //  perturb(fen, 'd1');

  function fromBoard() {
    var fen = chessground.getFen() + " w - - 0 1";
    console.log("fromBoard:" + fen);
    perturb(fen, 'd1');
  }

  function perturb(fen, perturbedSquare) {
    clear();
    var generator = new bundle.Generator(fen);
    var positions = generator.perturb(perturbedSquare);
    positions.forEach(p => stockfishQueue.enqueue(p, annotate));
  }

  function clear() {
    shapes = [];
    redrawShapes();
  }

  function annotate(position) {
    shapes.push({ orig: position.targetSquare, brush: brushScore(position.score) });
    /*
    let bestMove = position.bestMove;
    shapes.push({
      orig: bestMove.substring(0, 2),
      dest: bestMove.substring(2, 4),
      brush: brushScore(position.score)
    });
    */
    redrawShapes();
  }

  function redrawShapes() {
    chessground.set({
      drawable: {
        enabled: false,
        shapes: shapes
      }
    });
  }

  function brushScore(score) {
    switch (score) {
      case 'whiteWin':
        return 'green';
      case 'blackWin':
        return 'red';
      case 'drawn':
        return 'yellow';
      default:
        return 'blue';
    }
  }
</script>

</html>
