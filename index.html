<!doctype html>
<html lang="en">

<head>
  <title>Perturb-o-tron</title>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="description" content="analysis stockfish">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <link rel="stylesheet" href="assets/chessground.css" async>
  <link rel="stylesheet" href="assets/theme.css" async>
  <link rel="stylesheet" href="assets/examples.css">
  <script src="dist/main.js"></script>
</head>

<body>
  <h4>Perturb-o-tron</h4>
  <div class="all">
    <div class="cell">
      <section class="blue merida">
        <div id="chessground-examples"></div>
      </section>
      <br/>
      <br/> Status :
      <div id="status"></div>
    </div>
    <div class="cell">
      <pre>
      FEN     : <input type="text" id="fen" name="fen" value="8/8/4k3/8/8/8/4PK2/8 w - - 0 2" style="width: 250px;" onkeydown="onPressEnter(event,fenInputToBoard)" /><button onclick="lichessEditor()">Edit</button>
      Depth   : <input type="text" name="depth" id="depth" value="8" style="width: 30px;" />
      To play : <input type="radio" name="colour" id="colour" value="white" checked onclick="switchColourToPlay();"> White <input type="radio" name="colour" id="colourOther" value="black" onclick="switchColourToPlay();"> Black
      Perturb : <input type="text" id="perturb" name="perturb" value="b8" style="width: 30px;" readonly/> <button onclick="analyse()">Select</button>
      Explore : 
      
      <div id="explorer"></div>
      </pre>
    </div>
  </div>
</body>

<script defer>
  /* global bundle, WebAssembly, history */

  var fen = elt('fen').value;
  var chessground = bundle.Chessground(elt('chessground-examples'), bundle.AnalysisBoard.config(fen));
  var analysisBoard = new bundle.AnalysisBoard(loadStockfish(), chessground);

  var params = bundle.parse(window.location.href);
  if (params.fen) {
    elt('perturb').value = params.perturb;
    showFen(params.fen);
    onSelected(params.perturb);
  }

  function analyse() {
    setStatus("Select piece to perturb");
    analysisBoard.selectMode(onSelected);
  }

  function onSelected(square) {
    setStatus("Perturbing " + square);
    var fen = chessground.getFen() + elt('fen').value.replace(/[^ ]*/, '');
    elt('fen').value = fen;
    elt('perturb').value = square;
    analysisBoard.depth(elt('depth').value);
    analysisBoard.perturb(fen, square);
    elt('explorer').innerHTML = analysisBoard.views();
    updateUrlWithState();
  }

  function lichessEditor() {
    window.open("https://lichess.org/editor/" + chessground.getFen(), '_blank');
  }

  function onPressEnter(event, action) {
    (event.keyCode == 13) && action();
  }

  function fenInputToBoard() {
    elt('explorer').innerHTML = '';
    showFen(bundle.Util.fullFen(elt('fen').value));
  }

  function showFen(fen) {
    elt('fen').value = fen;
    elt('colour').checked = fen.includes('w');
    elt('colourOther').checked = !fen.includes('w');
    analysisBoard.showFen(fen);
  }

  function showFenAndPv(square) {
    analysisBoard.showFenAndPv(square);
    elt('perturb').value = square;
    elt('fen').value = bundle.Util.fullFen(analysisBoard.fenForTarget(square));
    updateUrlWithState();
  }

  function switchColourToPlay() {
    var colour = elt('colour').checked ? 'w' : 'b';
    elt('fen').value = elt('fen').value.replace(/[wb]/, colour);
    fenInputToBoard();
  }

  function setStatus(text) {
    elt('status').innerHTML = text;
  }

  function elt(e) {
    return document.getElementById(e);
  }

  function loadStockfish() {
    var wasmSupported = typeof WebAssembly === 'object' && WebAssembly.validate(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
    console.log("wasmSupported:" + wasmSupported);
    return new Worker(wasmSupported ? 'vendor/stockfish.wasm.js' : 'vendor/stockfish.js');
  }

  function updateUrlWithState() {
    if (history.pushState) {
      var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" +
        bundle.build({ fen: elt('fen').value, perturb: elt('perturb').value });
      window.history.pushState({
        path: newurl
      }, '', newurl);
    }
  }
</script>

</html>
